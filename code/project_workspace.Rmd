---
title: "BDA - Project workspace"
author: "Anonymous"
output: 
  pdf_document: 
    toc: yes
    toc_depth: 1
---

```{r setup, include=FALSE}
# This chunk just sets echo = TRUE as default (i.e. print all code)
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=TRUE, include=FALSE}
library(rstan)
library(ggplot2)

options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
Sys.setenv(LOCAL_CPPFLAGS = '-march=native')
SEED <- 48927 # set random seed for reproducability
```


# Analysis of survival chance relating to size of the maligant melanoma tumor size

This project analyses the chance to survive maligant melanoma with the thickness of melanoma tumor size. The data is a dataset collected at the Department of Plastic Surgery, University Hospital of Odense, Denmark from 1962 to 1977. Each patient had their tumour removed with surgical operation, with around 2,5cm of the surrounding skin. The dataset contains the survival time of each patient after the surgery, information about the patient (survived/died, sex, age), year of the operation, thickness of the tumour and if there were ulcers present in the tumour. The patients were followed to the end of 1977.

# Load Data

```{r}
csv <- read.csv("../data/Melanoma.csv", header=TRUE)
data_melanoma <- as.data.frame(csv)
#dead <- data_melanoma[data_melanoma$status == 1,]
#alive <- data_melanoma[data_melanoma$status != 1,]
input <- list(N = nrow(data_melanoma),
              x = data_melanoma$time,
              y = data_melanoma$thickness)
```

# Quick glimpse inside the dataset

Now to give you a rough understanding of what the data set looks like:

```{r}
data_melanoma$ulcer <- as.logical(data_melanoma$ulcer)
data_melanoma$sex [data_melanoma$sex == 1] <- "male"
data_melanoma$sex [data_melanoma$sex == 0] <- "female"
data_melanoma$sex <- as.factor(data_melanoma$sex)
data_melanoma$status <- as.factor(data_melanoma$status)

summary(data_melanoma)
head(data_melanoma)
```

Next a plot of the data values we are interested in, tumor thickness and survival time:

```{r}
ggplot() +
  geom_point(aes(x, y), data = data.frame(input), size = 1) +
  labs(y = 'Tumour thickness (cm)', x= 'Survival time (days)') +
  guides(linetype = F)
```

# Linear model

## Data

```{r}
fit_linear <- stan(file='project.stan', data=input, seed=SEED)
print(fit_linear)
data_extract <- as.data.frame(fit_linear)
```

## Plot

Plotting to see if linear correlation can be found:

```{r}
plot(data_extract$alpha, data_extract$beta, xlab = "Alpha", ylab = "Beta")
abline(lm(data_extract$beta ~ data_extract$alpha), col = "red")
```

The values seem to have a clear linear correlation.

## Diagnostics

Check convergence of chains:
```{r}
rstan::traceplot(fit_linear, pars=c('alpha','beta'))
```


HMC diagnostics:
```{r}
check_hmc_diagnostics(fit_linear)
```


Rhat diagnostics:

```{r}
rhat(fit_linear)
```



```{r}
monitor(fit_linear)
```


